<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, Shaifali - Family Feud!</title>
    <!-- Load Inter and Pacifico fonts from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Professional & Joyful Theme */
        :root {
            --primary-blue: #4A90E2;
            --secondary-gold: #FFC107;
            --accent-rose: #FF6F91;
            --text-dark: #2C3E50;
            --text-light: #4A4A4A;
            --background-light: #F8F9FA;
            --border-light: #E0E6EE;
            --button-blue: #3498DB;
            --button-purple: #8E44AD;
            --button-green: #27AE60;
            --button-red: #E74C3C;
            --button-orange: #F39C12;
            /* New, softer pastel colors for background theme */
            --bg-color-1: #FFEFD5; /* PapayaWhip */
            --bg-color-2: #FFDAB9; /* PeachPuff */
            --bg-color-3: #F5F5DC; /* Beige */
            --bg-color-4: #FFF8DC; /* Cornsilk */
        }

        body {
            font-family: "Inter", sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* New vibrant and celebratory background for the body - soft pastels */
            background-color: var(--bg-color-1);
            background-image: 
                url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNDQ0UyRTIiIGZpbGwtb3BhY2l0eT0iMC41Ij48cGF0aCBkPSJNMzYgMzFjLTQgMC02LTItNi02IDAtMiAxLTMgMi0zIDQgMCA2IDIgNiA2IDAgMi0xIDMtMiAzeiBNMTAgNWM0IDAgNiAyIDYgNiAwIDItMSAzLTIgMy00IDAtNi0yLTYtNiAwLTItMS0zLTItM3ogTTg0IDU1YzQgMCA2LTIsNi02IDAtMi0xLTMtMi0zLTQgMC02LTItNi02IDAtMi0xLTMtMi0zeiBNNzAgNDFjLTQgMC02LTItNi02IDAtMi0xLTMtMi0zLTQgMC02LTItNi02IDAtMi0xLTMtMi0zeiBNNDYgNjdjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNNDkgODVjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNNjcgNjFjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNODcgNjVjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNMTQgNzNjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNMTcgODNjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNNDUgNDFjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiBNNTAgNWM0IDAgNiAyIDYgNiAwIDItMSAzLTIgM3YtNC02LTItNi02IDAtMi0xLTMtMi0zIi8+PHBhdGggZD0iTTI2IDIxYy00IDAtNi0yLTYtNiAwLTItMS0zLTItMy00IDAtNi0yLTYtNiAwLTItMS0zLTItM3ogTTM5IDE5Yy00IDAtNi0yLTYtNiAwLTItMS0zLTItMy00IDAtNi0yLTYtNiAwLTItMS0zLTItM3ogTTggMjVjNCAwIDYtMiA2LTYgMC0yLTEtMy0yLTMtNCAwLTYtMi02LTYgMC0yLTEtMy0yLTMzeiIvPjwvZz48L2c+PC9zdmc+"), /* Subtle party pattern */
                linear-gradient(135deg, var(--bg-color-1) 0%, var(--bg-color-2) 30%, var(--bg-color-3) 70%, var(--bg-color-4) 100%); 
            background-attachment: fixed;
            background-size: 60px 60px, cover;
            color: var(--text-dark);
            overflow-x: hidden;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 0 0 4px var(--border-light);
            text-align: center;
            width: 95%;
            max-width: 800px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        h1 {
            font-family: 'Pacifico', cursive;
            font-size: 3.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-rose), var(--primary-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            font-family: "Inter", sans-serif;
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }
        p {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-light);
            font-weight: 400;
        }
        .screen {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            align-items: center;
        }
        .hidden {
            display: none !important;
        }
        button {
            background-color: var(--button-blue);
            color: white;
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 0.6rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            letter-spacing: 0.03em;
            background-image: linear-gradient(45deg, var(--button-blue), #2980B9);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            opacity: 0.9;
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #familyMemberModeButton { background-image: linear-gradient(45deg, var(--button-blue), #2C7BB6); }
        #familyMemberModeButton:hover { background-image: linear-gradient(45deg, #2C7BB6, #21618C); }
        #birthdayRevealModeButton { background-image: linear-gradient(45deg, var(--button-purple), #7B24A1); }
        #birthdayRevealModeButton:hover { background-image: linear-gradient(45deg, #7B24A1, #62177C); }
        #submitNameButton { background-image: linear-gradient(45deg, var(--button-green), #229954); }
        #submitNameButton:hover { background-image: linear-gradient(45deg, #229954, #1B7F42); }
        #fmNextQuestionButton, #brNextQuestionButton { background-image: linear-gradient(45deg, #5DADE2, #3498DB); }
        #fmNextQuestionButton:hover, #brNextQuestionButton:hover { background-image: linear-gradient(45deg, #3498DB, #2980B9); }
        #fmFinishButton, #brRevealFamilyAnswersButton { background-image: linear-gradient(45deg, var(--button-red), #C0392B); }
        #fmFinishButton:hover, #brRevealFamilyAnswersButton:hover { background-image: linear-gradient(45deg, #C0392B, #942E23); }
        #fmPlayAgainButton, #brPlayAgainButton, #fmRestartButton, #brRestartButton {
            background-image: linear-gradient(45deg, var(--secondary-gold), var(--button-orange));
            color: var(--text-dark);
        }
        #fmPlayAgainButton:hover, #brPlayAgainButton:hover, #fmRestartButton:hover, #brRestartButton:hover {
            background-image: linear-gradient(45deg, var(--button-orange), #C77D0A);
            color: var(--text-dark);
            opacity: 0.95;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.2rem;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            width: 100%;
            margin-top: 1.5rem;
        }
        .answer-slot {
            background-color: var(--background-light);
            border: 2px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1.2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 95px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        .answer-slot:hover:not(.selected-by-player):not(.shaifali-choice) {
            background-color: #F0F3F7;
            border-color: #B2C2D7;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .answer-slot.selected-by-player {
            background-color: #D4EDDA;
            border-color: #28A745;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
            animation: fadeInScale 0.3s ease-out forwards;
        }
        .answer-slot.shaifali-choice {
            background-color: #FFE0F0;
            border-color: var(--accent-rose);
            animation: pulse-border-professional 1.2s infinite alternate, fadeInScale 0.3s ease-out forwards;
            box-shadow: 0 4px 10px rgba(255, 111, 145, 0.3);
        }

        @keyframes pulse-border-professional {
            from { border-color: var(--accent-rose); box-shadow: 0 0 0 0 rgba(255, 111, 145, 0.5); }
            to { border-color: #E6496F; box-shadow: 0 0 0 6px rgba(255, 111, 145, 0); }
        }
        @keyframes fadeInScale {
            0% { transform: scale(0.95); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .answer-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            text-align: center;
            line-height: 1.3;
        }
        .family-count {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-top: 0.5rem;
            font-weight: 500;
        }
        
        #brScoreDisplay {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-top: 0.6rem;
            background-color: #E8F0F7;
            padding: 0.6rem 1.2rem;
            border-radius: 0.8rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #B0C4DE;
            display: inline-block;
        }
        #brTotalQuestions {
            font-size: 1.6rem;
            font-weight: 500;
            color: var(--text-light);
        }

        #brFinalScoreDisplay {
            font-family: 'Pacifico', cursive;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--secondary-gold), var(--button-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding: 0.8rem 1.8rem;
            border-radius: 1rem;
            margin-top: 1.5rem;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            border: 2px solid var(--secondary-gold);
        }
        .leaderboard {
            width: 100%;
            margin-top: 1.8rem;
            background-color: #F8F9FA;
            padding: 1.2rem;
            border-radius: 0.8rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-light);
        }
        .leaderboard h3 {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }
        .leaderboard ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .leaderboard li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid #EFF2F5;
            font-size: 1.15rem;
            color: var(--text-light);
            font-weight: 500;
        }
        .leaderboard li:last-child {
            border-bottom: none;
        }
        .winner {
            font-weight: 700;
            color: var(--button-green);
            font-size: 1.2rem;
            text-shadow: 0 0 8px rgba(39, 174, 96, 0.3);
            animation: pulse-winner-professional 1s infinite alternate;
        }
        @keyframes pulse-winner-professional {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.03); opacity: 0.9; }
        }

        #familyNameInput {
            margin-top: 0.8rem;
            padding: 0.7rem 1rem;
            border: 1px solid #D1D8E0;
            border-radius: 0.5rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
            font-size: 1rem;
            color: var(--text-dark);
            text-align: center;
            width: 70%;
            max-width: 280px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #familyNameInput:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
        }

        .message-box {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
            font-weight: 500;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1.2rem;
            font-size: 1.3rem;
            color: var(--primary-blue);
            text-shadow: 0 0 2px rgba(0,0,0,0.05);
            font-weight: 500;
        }
        .loading-spinner {
            border: 8px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-blue);
            border-top-color: var(--accent-rose);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Dynamic Celebration Effects --- */

        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--color);
            opacity: 0;
            animation: fall var(--duration) forwards;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 3px rgba(0,0,0,0.1);
            z-index: 999; /* Higher z-index for particles */
        }
        @keyframes fall {
            0% { transform: translateY(0) translateX(var(--initial-x)) rotate(0deg); opacity: 0.9; }
            100% { transform: translateY(100vh) translateX(var(--final-x)) rotate(1080deg); opacity: 0; }
        }

        /* Stars */
        .star-particle {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: yellow;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            opacity: 0;
            animation: star-burst var(--duration) forwards;
            pointer-events: none;
            filter: drop-shadow(0 0 5px rgba(255, 255, 0, 0.5));
            z-index: 999; /* Higher z-index for particles */
        }
        @keyframes star-burst {
            0% { transform: scale(0) translateY(0) rotate(0deg); opacity: 0; }
            20% { transform: scale(1) translateY(var(--initial-y)) translateX(var(--initial-x)) rotate(var(--initial-rotate)); opacity: 1; }
            100% { transform: scale(0.5) translateY(var(--final-y)) translateX(var(--final-x)) rotate(var(--final-rotate)); opacity: 0; }
        }

        /* Hearts */
        .heart-particle {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #FF6F91;
            transform: rotate(-45deg);
            opacity: 0;
            animation: heart-float var(--duration) forwards;
            pointer-events: none;
            filter: drop-shadow(0 0 3px rgba(255, 111, 145, 0.4));
            z-index: 999; /* Higher z-index for particles */
        }
        .heart-particle::before,
        .heart-particle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #FF6F91;
            border-radius: 50%;
        }
        .heart-particle::before {
            top: -10px;
            left: 0;
        }
        .heart-particle::after {
            left: 10px;
            top: 0;
        }
        @keyframes heart-float {
            0% { transform: translateY(0) translateX(var(--initial-x)) rotate(-45deg); opacity: 0.8; }
            100% { transform: translateY(-100vh) translateX(var(--final-x)) rotate(315deg); opacity: 0; }
        }

        /* Unicorn SVG - will be inserted directly via JS */
        .unicorn-particle {
            position: absolute;
            opacity: 0;
            animation: unicorn-fly var(--duration) forwards;
            pointer-events: none;
            width: 50px; /* Size of the unicorn */
            height: auto;
            filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.2));
            z-index: 999; /* Higher z-index for particles */
        }
        @keyframes unicorn-fly {
            0% { transform: translateY(0) translateX(var(--initial-x)) rotate(0deg) scale(0.5); opacity: 0; }
            20% { transform: translateY(var(--mid-y)) translateX(var(--mid-x)) rotate(var(--mid-rotate)) scale(1); opacity: 1; }
            100% { transform: translateY(var(--final-y)) translateX(var(--final-x)) rotate(var(--final-rotate)) scale(0.5); opacity: 0; }
        }

        /* Cute Animal Image Styling */
        .cute-animal-image {
            width: 150px; /* Consistent size for animals */
            height: 150px;
            border-radius: 50%; /* Circular */
            object-fit: cover; /* Ensures image fills without distortion */
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border: 4px solid var(--secondary-gold); /* Gold border */
            position: absolute; /* Allows for floating */
            transition: all 0.5s ease-in-out;
            animation: subtle-float 4s ease-in-out infinite alternate;
            z-index: 1; /* Below game content, above background */
        }
        @keyframes subtle-float {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }
        #revealPuppy {
            top: 20px;
            left: 20px;
            transform: rotate(-5deg);
        }
        #endKitten {
            bottom: 20px;
            left: 20px;
            transform: rotate(5deg);
        }
        #endBunny {
            bottom: 20px;
            right: 20px;
            transform: rotate(-8deg);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
                gap: 1rem;
            }
            h1 {
                font-size: 2.5rem;
            }
            h2 {
                font-size: 1.8rem;
            }
            p {
                font-size: 0.95rem;
            }
            button {
                padding: 0.7rem 1.2rem;
                font-size: 1rem;
                width: 100%;
            }
            .button-group {
                flex-direction: column;
                gap: 0.8rem;
            }
            .answer-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            .answer-slot {
                min-height: 80px;
                padding: 1rem;
            }
            .answer-text {
                font-size: 1.1rem;
            }
            .family-count {
                font-size: 0.85rem;
            }
            #brScoreDisplay {
                font-size: 2rem;
                padding: 0.4rem 0.8rem;
            }
            #brTotalQuestions {
                font-size: 1.3rem;
            }
            #brFinalScoreDisplay {
                font-size: 2.8rem;
                padding: 0.6rem 1rem;
            }
            .leaderboard h3 {
                font-size: 1.4rem;
            }
            .leaderboard li {
                font-size: 1rem;
            }
            .winner {
                font-size: 1.1rem;
            }
            .cute-animal-image { /* Hide on very small screens to prevent clutter */
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Happy Birthday, Shaifali!</h1>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
            <p>Loading game data...</p>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="message-box"></div>

        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="screen">
            <h2>Select Your Role</h2>
            <div class="button-group">
                <button id="familyMemberModeButton">I am a Family Member</button>
                <button id="birthdayRevealModeButton">It's Shaifali's Birthday Reveal!</button>
            </div>
            <p class="text-sm text-gray-500 mt-4">Family members submit their answers. Shaifali reveals the results!</p>
        </div>

        <!-- Family Member Screen -->
        <div id="familyMemberScreen" class="screen hidden">
            <h2>Your Turn, Family Member!</h2>
            <div id="nameEntrySection">
                <p>Please enter your name:</p>
                <input type="text" id="familyNameInput" placeholder="Your Name" 
                       class="mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full max-w-xs text-center">
                <button id="submitNameButton" class="mt-4">Start Answering</button>
            </div>
            
            <div id="questionsSection" class="hidden">
                <p id="fmQuestionText" class="text-xl font-semibold"></p>
                <div id="fmAnswersGrid" class="answer-grid">
                    <!-- Answers will be loaded here -->
                </div>
                <p id="fmFeedback" class="text-md text-gray-600 italic"></p>
                <div class="button-group">
                    <button id="fmNextQuestionButton" class="hidden">Next Question</button>
                    <button id="fmFinishButton" class="hidden">I'm Done Answering!</button>
                    <button id="fmRestartButton">Restart My Answers</button>
                </div>
            </div>
        </div>

        <!-- Family Member End Screen -->
        <div id="fmEndScreen" class="screen hidden">
            <h2>Thank You for Participating!</h2>
            <p>Your responses have been recorded for Shaifali's big reveal. Come back later for the results!</p>
            <div class="button-group">
                 <button id="fmPlayAgainButton">Choose Another Mode</button>
            </div>
        </div>

        <!-- Birthday Reveal Screen (for Shaifali) -->
        <div id="birthdayRevealScreen" class="screen hidden">
            <h2>Happy Birthday, Shaifali! Your Turn!</h2>
            <p class="text-lg">Questions Answered: <span id="brScoreDisplay" class="font-bold">0</span> / <span id="brTotalQuestions"></span></p>
            <p id="brQuestionText" class="text-xl font-semibold"></p>
            <div id="brAnswersGrid" class="answer-grid">
                <!-- Shaifali's choices and revealed family answers will go here -->
            </div>
            <div class="button-group">
                <button id="brRevealFamilyAnswersButton">Reveal Family's Answers!</button>
                <button id="brNextQuestionButton" class="hidden">Next Question</button>
                <button id="brRestartButton" class="hidden">Restart Game</button>
            </div>
            <!-- Cute Puppy Image for Birthday Reveal Screen -->
            <img id="revealPuppy" src="https://placehold.co/150x150/FFC0CB/4B0082?text=Cute+Puppy" alt="Cute Puppy" class="cute-animal-image" onerror="this.onerror=null;this.src='https://placehold.co/150x150/CCCCCC/FFFFFF?text=Image+Error';">
        </div>

        <!-- Birthday Reveal End Screen -->
        <div id="brEndScreen" class="screen hidden">
            <h2>Happy Birthday, Shaifali!</h2>
            <p class="text-2xl font-bold">The Family Member(s) Who Know Shaifali Best:</p>
            <p id="brFinalScoreDisplay" class="font-extrabold"></p>
            <div class="leaderboard">
                <h3>Match Counts:</h3>
                <ul id="leaderboardList">
                    <!-- Leaderboard items will be inserted here -->
                </ul>
            </div>
            <p>Thank you for playing!</p>
            <div class="button-group">
                <button id="brPlayAgainButton">Play Again!</button>
            </div>
            <!-- Cute Kitten & Bunny Images for End Screen -->
            <img id="endKitten" src="https://placehold.co/150x150/ADD8E6/4B0082?text=Cute+Kitten" alt="Cute Kitten" class="cute-animal-image" onerror="this.onerror=null;this.src='https://placehold.co/150x150/CCCCCC/FFFFFF?text=Image+Error';">
            <img id="endBunny" src="https://placehold.co/150x150/90EE90/4B0082?text=Baby+Bunny" alt="Baby Bunny" class="cute-animal-image" onerror="this.onerror=null;this.src='https://placehold.co/150x150/CCCCCC/FFFFFF?text=Image+Error';">
        </div>

    </div> <!-- End .container -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, addDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment, or fallback for external hosting
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const canvasFirebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const canvasInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Use a consistent appId for Firestore paths. This should match your GitHub repo name for easy identification.
        // For external hosting, this fixed string is used. In Canvas, __app_id would be used.
        window.appId = 'shaifali-birthday-feud'; 
        console.log("Using Firestore App ID:", window.appId);

        // Your Firebase Configuration - NOW CONFIGURED WITH YOUR PROVIDED DETAILS!
        const firebaseConfigString = `{
            "apiKey": "AIzaSyApx7Gs5FDgli_nUN83ZbXYmravQypWst0", 
            "authDomain": "shaifali-birthday-game.firebaseapp.com",
            "projectId": "shaifali-birthday-game",
            "storageBucket": "shaifali-birthday-game.appspot.com",
            "messagingSenderId": "732885727906",
            "appId": "1:732885727906:web:YOUR_APP_ID_FROM_FIREBASE" 
        }`;

        let app;
        let auth;
        let db;
        let userId = 'unknown'; 

        // Expose Firebase services globally for convenience, used by game logic
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = userId; 
        // Expose Firestore utility functions globally
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;
        window.doc = doc; 
        window.setDoc = setDoc; 
        window.getDoc = getDoc; 

        // Firebase Authentication Listener setup
        let firebaseAuthReadyResolver;
        const firebaseAuthReadyPromise = new Promise(resolve => {
            firebaseAuthReadyResolver = resolve;
        });
        window.firebaseAuthReadyPromise = firebaseAuthReadyPromise; 

        async function initFirebase() {
            try {
                let configToUse;
                let authTokenToUse = null;

                if (canvasFirebaseConfigString !== '{}' && canvasAppId !== 'default-app-id') {
                    console.log('Using Firebase config from Canvas environment.');
                    configToUse = JSON.parse(canvasFirebaseConfigString);
                    authTokenToUse = canvasInitialAuthToken;
                    window.appId = canvasAppId; 
                } else {
                    console.log('Using Firebase config from HTML script (for GitHub Pages/external hosting).');
                    configToUse = JSON.parse(firebaseConfigString);
                    authTokenToUse = null; 
                }
                
                console.log('Final Firebase Config for initialization:', configToUse);

                app = initializeApp(configToUse);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log('Firebase app and services initialized.');

                window.firebaseApp = app;
                window.db = db;
                window.auth = auth;

                if (authTokenToUse) {
                    console.log('Attempting to sign in with custom token...');
                    await signInWithCustomToken(auth, authTokenToUse);
                } else {
                    console.log('No custom token found, attempting anonymous sign-in...');
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        window.currentUserId = userId; 
                        console.log('User authenticated. UID:', userId);
                    } else {
                        console.log('No user is signed in, or anonymous sign-in failed.');
                        userId = 'anonymous_failed'; 
                        window.currentUserId = userId; 
                    }
                    firebaseAuthReadyResolver(); 
                });

            } catch (error) {
                console.error('Firebase initialization or authentication failed:', error);
                document.body.innerHTML = `
                    <div style="text-align: center; color: red; padding: 20px; font-family: 'Inter', sans-serif;">
                        <h1>Firebase Initialization Error</h1>
                        <p>Something went wrong during Firebase setup.</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please ensure your Firebase project configuration is correct and enabled.</p>
                        <p>Reload the page to try again.</p>
                    </div>
                `;
                firebaseAuthReadyResolver(); 
            }
        }

        // --- Game Initialization and Mode Selection ---
        document.addEventListener('DOMContentLoaded', async () => {
            const initialLoadingOverlay = document.getElementById('loadingOverlay');
            if (initialLoadingOverlay) {
                initialLoadingOverlay.classList.remove('hidden');
            }

            await initFirebase(); 
            await window.firebaseAuthReadyPromise; 

            if (initialLoadingOverlay) {
                initialLoadingOverlay.classList.add('hidden');
            }

            if (window.currentUserId && window.currentUserId !== 'anonymous_failed') {
                initializeGame();
            } else {
                console.error("Firebase authentication failed. Game cannot start. Check console for details.");
                showMessage("Failed to authenticate with Firebase. Game cannot start. Please ensure your Firebase API Key is valid and try refreshing.", "error");
            }
        });


        const WIFE_NAME = "Shaifali";
        let currentQuestionIndex = 0;
        let shaifaliQuestionsAnswered = 0; 
        let gameMode = ''; 
        let currentUserAnswered = new Set(); 
        let currentFamilyMemberName = ''; 
        let familyOverallMatchCounts = {}; 

        const allQuestions = [
            { id: 'q1', question: `Who does Shaifali miss the most?`, answers: [{ text: "Mother" }, { text: "Father" }, { text: "Ritul (Brother)" }, { text: "Grandparents" }] },
            { id: 'q2', question: `Who does Shaifali love the most?`, answers: [{ text: "Mother" }, { text: "Father" }, { text: "Ritul (Brother)" }, { text: "Kamal Aunty" }] },
            { id: 'q3', question: `Where does Shaifali want to go for a vacation?`, answers: [{ text: "Kharar" }, { text: "Beach Resort" }, { text: "Mountain Getaway" }, { text: "European City" }] },
            { id: 'q4', question: `What is Shaifali's favorite food?`, answers: [{ text: "Pasta" }, { text: "Pizza" }, { text: "Indian Cuisine" }, { text: "Sushi" }] },
            { id: 'q5', question: `What does Shaifali like to do in her free time?`, answers: [{ text: "Cooking" }, { text: "Reading" }, { text: "Gardening" }, { text: "Watching Movies/TV" }] },
            { id: 'q6', question: `What is Shaifali's profession?`, answers: [{ text: "Dentist" }, { text: "Doctor" }, { text: "Teacher" }, { text: "Engineer" }] },
            { id: 'q7', question: `Where does Shaifali like to sit in a car?`, answers: [{ text: "Front Passenger Seat" }, { text: "Driver's Seat" }, { text: "Back Seat (Left)" }, { text: "Back Seat (Right)" }] },
            { id: 'q8', question: `What is Shaifali's favorite color?`, answers: [{ text: "Pink" }, { text: "Blue" }, { text: "Purple" }, { text: "Green" }] },
            { id: 'q9', question: `What kind of music does Shaifali prefer?`, answers: [{ text: "Bollywood Hits" }, { text: "Pop" }, { text: "Classical" }, { text: "Rock" }] },
            { id: 'q10', question: `What is Shaifali's favorite season?`, answers: [{ text: "Spring" }, { text: "Winter" }, { text: "Summer" }, { text: "Autumn" }] }
        ];

        let modeSelectionScreen;
        let familyMemberScreen;
        let birthdayRevealScreen;
        let fmEndScreen;
        let brEndScreen;

        let familyMemberModeButton;
        let birthdayRevealModeButton;

        let nameEntrySection;
        let familyNameInput;
        let submitNameButton;
        let questionsSection;

        let fmQuestionText;
        let fmAnswersGrid;
        let fmFeedback;
        let fmNextQuestionButton;
        let fmFinishButton;
        let fmPlayAgainButton;
        let fmRestartButton;

        let brQuestionText;
        let brAnswersGrid;
        let brScoreDisplay; 
        let brTotalQuestions; 
        let brRevealFamilyAnswersButton;
        let brNextQuestionButton;
        let brFinalScoreDisplay; 
        let brPlayAgainButton;
        let brRestartButton;
        let leaderboardList; 

        let messageBox;
        let loadingOverlay;

        function assignDOMElements() {
            modeSelectionScreen = document.getElementById('modeSelectionScreen');
            familyMemberScreen = document.getElementById('familyMemberScreen');
            birthdayRevealScreen = document.getElementById('birthdayRevealScreen');
            fmEndScreen = document.getElementById('fmEndScreen');
            brEndScreen = document.getElementById('brEndScreen');

            familyMemberModeButton = document.getElementById('familyMemberModeButton');
            birthdayRevealModeButton = document.getElementById('birthdayRevealModeButton');

            nameEntrySection = document.getElementById('nameEntrySection');
            familyNameInput = document.getElementById('familyNameInput');
            submitNameButton = document.getElementById('submitNameButton');
            questionsSection = document.getElementById('questionsSection');

            fmQuestionText = document.getElementById('fmQuestionText');
            fmAnswersGrid = document.getElementById('fmAnswersGrid');
            fmFeedback = document.getElementById('fmFeedback');
            fmNextQuestionButton = document.getElementById('fmNextQuestionButton');
            fmFinishButton = document.getElementById('fmFinishButton');
            fmPlayAgainButton = document.getElementById('fmPlayAgainButton');
            fmRestartButton = document.getElementById('fmRestartButton');

            brQuestionText = document.getElementById('brQuestionText');
            brAnswersGrid = document.getElementById('brAnswersGrid');
            brScoreDisplay = document.getElementById('brScoreDisplay');
            brTotalQuestions = document.getElementById('brTotalQuestions');
            brRevealFamilyAnswersButton = document.getElementById('brRevealFamilyAnswersButton');
            brNextQuestionButton = document.getElementById('brNextQuestionButton');
            brFinalScoreDisplay = document.getElementById('brFinalScoreDisplay');
            brPlayAgainButton = document.getElementById('brPlayAgainButton');
            brRestartButton = document.getElementById('brRestartButton');
            leaderboardList = document.getElementById('leaderboardList');


            messageBox = document.getElementById('messageBox');
            loadingOverlay = document.getElementById('loadingOverlay');

            if (document.querySelector('h1')) { 
                document.querySelector('h1').textContent = `Happy Birthday, ${WIFE_NAME}!`;
            }
            if(fmEndScreen && fmEndScreen.querySelector('h2')) { 
                 fmEndScreen.querySelector('h2').textContent = `Thank You for Participating!`;
            }
            if(brEndScreen && brEndScreen.querySelector('h2')) {
                brEndScreen.querySelector('h2').textContent = `Happy Birthday, ${WIFE_NAME}!`;
            }
            if (brTotalQuestions) brTotalQuestions.textContent = allQuestions.length;
        }

        function showMessage(message, type) {
            if (messageBox) { 
                messageBox.textContent = message;
                messageBox.className = 'message-box show';
                if (type === 'success') {
                    messageBox.style.backgroundColor = '#d4edda';
                    messageBox.style.borderColor = '#c3e6cb';
                    messageBox.style.color = '#155724';
                } else if (type === 'error') {
                    messageBox.style.backgroundColor = '#f8d7da';
                    messageBox.style.borderColor = '#f5c6cb';
                    messageBox.style.color = '#721c24';
                } else {
                    messageBox.style.backgroundColor = '#fff3cd';
                    messageBox.style.borderColor = '#ffeeba';
                    messageBox.style.color = '#856404';
                }
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            } else {
                console.warn("showMessage called before messageBox is available:", message);
            }
        }

        function showLoading(show) {
            if (loadingOverlay) { 
                if (show) {
                    loadingOverlay.classList.remove('hidden');
                } else {
                    loadingOverlay.classList.add('hidden');
                }
            } else {
                console.warn("showLoading called before loadingOverlay is available.");
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initializeGame() {
            assignDOMElements(); 

            if (!familyMemberModeButton || !birthdayRevealModeButton) {
                console.error("Critical: Game mode buttons not found. Cannot initialize game listeners.");
                showMessage("Critical Error: Game elements not found. Please refresh.", "error");
                return;
            }

            familyMemberModeButton.addEventListener('click', () => selectMode('collect_responses'));
            birthdayRevealModeButton.addEventListener('click', () => selectMode('birthday_reveal'));

            fmNextQuestionButton.addEventListener('click', loadNextQuestion);
            fmFinishButton.addEventListener('click', () => endFamilyMemberMode());
            fmPlayAgainButton.addEventListener('click', () => resetGame('collect_responses', true)); 
            fmRestartButton.addEventListener('click', () => resetGame('collect_responses'));
            submitNameButton.addEventListener('click', submitFamilyMemberName); 

            brRevealFamilyAnswersButton.addEventListener('click', handleRevealFamilyAnswers);
            brNextQuestionButton.addEventListener('click', loadNextQuestion);
            brPlayAgainButton.addEventListener('click', () => resetGame('birthday_reveal', true)); 
            brRestartButton.addEventListener('click', () => resetGame('birthday_reveal'));
            
            modeSelectionScreen.classList.remove('hidden');
        }

        function selectMode(mode) {
            gameMode = mode;
            modeSelectionScreen.classList.add('hidden');
            currentQuestionIndex = 0; 
            shaifaliQuestionsAnswered = 0; 
            familyOverallMatchCounts = {}; 
            updateScoreDisplay(); 

            // Show/hide animal images based on mode
            document.getElementById('revealPuppy').classList.add('hidden');
            document.getElementById('endKitten').classList.add('hidden');
            document.getElementById('endBunny').classList.add('hidden');

            if (gameMode === 'collect_responses') {
                familyMemberScreen.classList.remove('hidden');
                nameEntrySection.classList.remove('hidden');
                questionsSection.classList.add('hidden');
                familyNameInput.value = localStorage.getItem('familyMemberName') || ''; 
            } else { 
                birthdayRevealScreen.classList.remove('hidden');
                document.getElementById('revealPuppy').classList.remove('hidden'); // Show puppy for Shaifali
                loadBirthdayRevealQuestion(currentQuestionIndex);
            }
        }

        function submitFamilyMemberName() {
            const name = familyNameInput.value.trim();
            if (name) {
                currentFamilyMemberName = name;
                localStorage.setItem('familyMemberName', name); 
                nameEntrySection.classList.add('hidden');
                questionsSection.classList.remove('hidden');
                loadFamilyMemberQuestion(currentQuestionIndex);
            } else {
                showMessage("Please enter your name!", "warning");
            }
        }

        function resetGame(mode, returnToModeSelection = false) {
            if (mode === 'collect_responses') {
                familyMemberScreen.classList.add('hidden');
                fmEndScreen.classList.add('hidden');
                currentUserAnswered.clear(); 
                fmFeedback.textContent = '';
                fmNextQuestionButton.classList.add('hidden');
                fmFinishButton.classList.add('hidden');
                fmRestartButton.classList.add('hidden');
                if (!returnToModeSelection) {
                    nameEntrySection.classList.remove('hidden');
                    questionsSection.classList.add('hidden');
                }
            } else { 
                birthdayRevealScreen.classList.add('hidden');
                brEndScreen.classList.add('hidden');
                brNextQuestionButton.classList.add('hidden');
                brRevealFamilyAnswersButton.classList.remove('hidden'); 
                brRestartButton.classList.add('hidden');
                // Hide animal images when resetting reveal mode
                document.getElementById('revealPuppy').classList.add('hidden');
                document.getElementById('endKitten').classList.add('hidden');
                document.getElementById('endBunny').classList.add('hidden');
            }

            if (returnToModeSelection) {
                modeSelectionScreen.classList.remove('hidden');
                removeAllParticles(); // Clear all particles
                gameMode = '';
                currentFamilyMemberName = ''; 
                localStorage.removeItem('familyMemberName');
            } else {
                selectMode(mode); 
            }
        }


        async function loadFamilyMemberQuestion(index) {
            if (index >= allQuestions.length) {
                endFamilyMemberMode();
                return;
            }

            fmNextQuestionButton.classList.add('hidden');
            fmFinishButton.classList.add('hidden');
            fmFeedback.textContent = '';
            showLoading(true);

            const currentQ = allQuestions[index];
            fmQuestionText.textContent = `Q${index + 1}: ${currentQ.question}`;
            fmAnswersGrid.innerHTML = '';

            const responseDocRef = window.collection(window.db, `artifacts/${window.appId}/public/data/family_responses`);
            const q = window.query(responseDocRef, 
                                 window.where("userId", "==", window.currentUserId), 
                                 window.where("questionId", "==", currentQ.id));

            try {
                const querySnapshot = await window.getDocs(q);
                if (!querySnapshot.empty) {
                    const existingAnswer = querySnapshot.docs[0].data().selectedAnswerText;
                    fmFeedback.textContent = `You already answered this question! You picked: "${existingAnswer}". Your name: "${querySnapshot.docs[0].data().userName}"`;
                    currentUserAnswered.add(currentQ.id); 
                    displayFamilyMemberOptions(currentQ.answers, existingAnswer, true); 
                } else {
                    displayFamilyMemberOptions(currentQ.answers);
                }
            } catch (error) {
                console.error("Error checking user answer:", error);
                showMessage("Failed to load question status. Please try again.", "error");
            } finally {
                showLoading(false);
                updateFamilyMemberNavButtons();
            }
        }

        function displayFamilyMemberOptions(answers, preselectedAnswerText = '', disableClicks = false) {
            let shuffledAnswers = answers.map(a => ({...a})); 
            shuffleArray(shuffledAnswers);

            fmAnswersGrid.innerHTML = ''; 
            shuffledAnswers.forEach((answer, i) => {
                const answerSlot = document.createElement('div');
                answerSlot.classList.add('answer-slot');
                answerSlot.id = `fm-answer-slot-${i}`;
                answerSlot.dataset.questionId = allQuestions[currentQuestionIndex].id;
                answerSlot.dataset.answerText = answer.text;

                if (answer.text === preselectedAnswerText) {
                    answerSlot.classList.add('selected-by-player');
                    answerSlot.innerHTML = `<span class="answer-text">${answer.text}</span><span class="family-count">Your Choice</span>`;
                } else {
                     answerSlot.innerHTML = `<span class="answer-text">${answer.text}</span>`;
                }

                if (!disableClicks) {
                    answerSlot.addEventListener('click', handleFamilyMemberSelection);
                } else {
                    answerSlot.style.cursor = 'default';
                }
                fmAnswersGrid.appendChild(answerSlot);
            });
        }


        async function handleFamilyMemberSelection(event) {
            if (!currentFamilyMemberName) {
                showMessage("Please enter your name first!", "error");
                return;
            }

            const selectedSlot = event.currentTarget;
            const questionId = selectedSlot.dataset.questionId;
            const selectedAnswerText = selectedSlot.dataset.answerText;

            const allSlots = fmAnswersGrid.querySelectorAll('.answer-slot');
            allSlots.forEach(slot => {
                slot.removeEventListener('click', handleFamilyMemberSelection);
                slot.style.cursor = 'default';
            });

            selectedSlot.classList.add('selected-by-player');
            selectedSlot.innerHTML = `<span class="answer-text">${selectedAnswerText}</span><span class="family-count">Your Choice</span>`;

            showLoading(true);
            try {
                const responseRef = window.collection(window.db, `artifacts/${window.appId}/public/data/family_responses`);
                await window.addDoc(responseRef, {
                    userId: window.currentUserId,
                    userName: currentFamilyMemberName, 
                    questionId: questionId,
                    selectedAnswerText: selectedAnswerText,
                    timestamp: new Date()
                });
                fmFeedback.textContent = `Thanks for your answer! You picked "${selectedAnswerText}".`;
                currentUserAnswered.add(questionId); 
                showMessage("Your answer has been recorded!", "success");
            } catch (error) {
                console.error("Error submitting family member answer:", error);
                fmFeedback.textContent = "Failed to record your answer. Please try again.";
                showMessage("Failed to record your answer.", "error");
            } finally {
                showLoading(false);
                updateFamilyMemberNavButtons();
            }
        }

        function updateFamilyMemberNavButtons() {
            const currentQ = allQuestions[currentQuestionIndex];
            if (currentUserAnswered.has(currentQ.id)) {
                if (currentQuestionIndex < allQuestions.length - 1) {
                    fmNextQuestionButton.classList.remove('hidden');
                } else {
                    fmFinishButton.classList.remove('hidden');
                }
            } else {
                fmNextQuestionButton.classList.add('hidden');
                fmFinishButton.classList.add('hidden');
            }
            if (fmRestartButton) fmRestartButton.classList.remove('hidden');
        }

        function loadNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < allQuestions.length) {
                if (gameMode === 'collect_responses') {
                    loadFamilyMemberQuestion(currentQuestionIndex);
                } else { 
                    loadBirthdayRevealQuestion(currentQuestionIndex);
                }
            } else {
                if (gameMode === 'collect_responses') {
                    endFamilyMemberMode();
                } else { 
                    endBirthdayRevealMode();
                }
            }
        }

        function endFamilyMemberMode() {
            familyMemberScreen.classList.add('hidden');
            fmEndScreen.classList.remove('hidden');
        }

        let shaifaliChosenAnswer = null; 

        async function loadBirthdayRevealQuestion(index) {
            if (index >= allQuestions.length) {
                endBirthdayRevealMode();
                return;
            }

            if (brNextQuestionButton) brNextQuestionButton.classList.add('hidden');
            if (brRevealFamilyAnswersButton) brRevealFamilyAnswersButton.classList.remove('hidden');
            if (brRestartButton) brRestartButton.classList.add('hidden'); 

            shaifaliChosenAnswer = null; 

            const currentQ = allQuestions[index];
            if (brQuestionText) brQuestionText.textContent = `Q${index + 1}: ${currentQ.question}`;
            if (brAnswersGrid) brAnswersGrid.innerHTML = '';

            const shaifaliAnswerRef = window.doc(window.db, `artifacts/${window.appId}/public/data/shaifali_answers`, currentQ.id);
            try {
                const docSnap = await window.getDoc(shaifaliAnswerRef);
                if (docSnap.exists()) {
                    shaifaliChosenAnswer = { text: docSnap.data().answerText };
                    shaifaliQuestionsAnswered = index + 1; 
                    updateScoreDisplay(); 
                    
                    displayShaifaliOptions(currentQ.answers, shaifaliChosenAnswer.text, true); 
                    handleRevealFamilyAnswers(true); 
                } else {
                    shaifaliQuestionsAnswered = index; 
                    updateScoreDisplay(); 
                    displayShaifaliOptions(currentQ.answers); 
                }
            } catch (error) {
                console.error("Error checking Shaifali's answer:", error);
                showMessage("Failed to load Shaifali's previous answer. Please try again.", "error");
                displayShaifaliOptions(currentQ.answers); 
            }
            updateBirthdayRevealNavButtons();
        }

        function displayShaifaliOptions(answers, preselectedAnswerText = '', disableClicks = false) {
            let shuffledAnswers = answers.map(a => ({...a}));
            shuffleArray(shuffledAnswers);

            brAnswersGrid.innerHTML = ''; 
            shuffledAnswers.forEach((answer, i) => {
                const answerSlot = document.createElement('div');
                answerSlot.classList.add('answer-slot');
                answerSlot.id = `br-answer-slot-${i}`;
                answerSlot.dataset.originalText = answer.text;
                answerSlot.innerHTML = `<span class="answer-text">${answer.text}</span>`;

                if (answer.text === preselectedAnswerText) {
                    answerSlot.classList.add('shaifali-choice');
                }

                if (!disableClicks) {
                    answerSlot.addEventListener('click', handleShaifaliSelection);
                } else {
                    answerSlot.style.cursor = 'default';
                }
                brAnswersGrid.appendChild(answerSlot);
            });
        }

        async function handleShaifaliSelection(event) {
            const selectedSlot = event.currentTarget;
            const allSlots = brAnswersGrid.querySelectorAll('.answer-slot');

            allSlots.forEach(slot => {
                slot.classList.remove('shaifali-choice');
            });

            selectedSlot.classList.add('shaifali-choice');
            shaifaliChosenAnswer = {
                text: selectedSlot.dataset.originalText
            };
            
            showLoading(true);
            try {
                const currentQ = allQuestions[currentQuestionIndex];
                const shaifaliAnswerRef = window.doc(window.db, `artifacts/${window.appId}/public/data/shaifali_answers`, currentQ.id);
                await window.setDoc(shaifaliAnswerRef, {
                    answerText: shaifaliChosenAnswer.text,
                    timestamp: new Date(),
                    questionId: currentQ.id 
                });
                shaifaliQuestionsAnswered = currentQuestionIndex + 1; 
                updateScoreDisplay();
                showMessage(`Shaifali selected: ${shaifaliChosenAnswer.text} (Answer Saved!)`, "success");

                // Trigger celebration effect based on question index
                triggerCelebrationEffect(currentQuestionIndex);

            } catch (error) {
                console.error("Error saving Shaifali's answer:", error);
                showMessage("Failed to save Shaifali's answer. Please try again.", "error");
            } finally {
                showLoading(false);
            }
            
            if (brRevealFamilyAnswersButton) brRevealFamilyAnswersButton.classList.remove('hidden'); 
            updateBirthdayRevealNavButtons();
        }

        async function handleRevealFamilyAnswers(autoReveal = false) {
            if (!shaifaliChosenAnswer) {
                showMessage("Shaifali, please select your answer first!", "warning");
                return;
            }

            if (brRevealFamilyAnswersButton) brRevealFamilyAnswersButton.classList.add('hidden'); 
            showLoading(true);

            try {
                const currentQ = allQuestions[currentQuestionIndex];
                
                let shaifaliOfficialAnswerText = shaifaliChosenAnswer.text;

                const familyResponsesRef = window.collection(window.db, `artifacts/${window.appId}/public/data/family_responses`);
                const q = window.query(familyResponsesRef, window.where("questionId", "==", currentQ.id));
                const querySnapshot = await window.getDocs(q);

                const familyAnswersMap = {}; 
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (!data.selectedAnswerText || !data.userName) return; 
                    
                    familyAnswersMap[data.selectedAnswerText] = (familyAnswersMap[data.selectedAnswerText] || { count: 0, members: [] });
                    familyAnswersMap[data.selectedAnswerText].count++;
                    familyAnswersMap[data.selectedAnswerText].members.push(data.userName);

                    if (data.selectedAnswerText === shaifaliOfficialAnswerText) {
                        familyOverallMatchCounts[data.userName] = (familyOverallMatchCounts[data.userName] || 0) + 1;
                    }
                });

                const allSlots = brAnswersGrid.querySelectorAll('.answer-slot');
                allSlots.forEach(slot => {
                    const answerText = slot.dataset.originalText;
                    const answerData = familyAnswersMap[answerText] || { count: 0, members: [] };
                    const count = answerData.count;
                    const members = answerData.members;

                    const countSpan = document.createElement('span');
                    countSpan.classList.add('family-count');
                    countSpan.textContent = `Family: ${count} ${members.length > 0 ? `(${members.join(', ')})` : ''}`;
                    slot.appendChild(countSpan);

                    if (answerText === shaifaliOfficialAnswerText) {
                        if (!slot.classList.contains('shaifali-choice')) {
                             slot.classList.add('shaifali-choice');
                        }
                        const shaifaliChoiceIndicator = document.createElement('span');
                        shaifaliChoiceIndicator.classList.add('family-count', 'text-orange-700', 'font-bold');
                        shaifaliChoiceIndicator.textContent = `Shaifali's Choice`;
                        slot.appendChild(shaifaliChoiceIndicator);
                    }

                    slot.style.cursor = 'default'; 
                    slot.removeEventListener('click', handleShaifaliSelection);
                });
                
                if (!autoReveal) { 
                    showMessage("Family answers revealed!", "success");
                }

            } catch (error) {
                console.error("Error fetching family responses:", error);
                showMessage("Failed to fetch family responses. Please try again.", "error");
            } finally {
                showLoading(false);
                updateBirthdayRevealNavButtons();
            }
        }

        function updateScoreDisplay() {
            if (brScoreDisplay) brScoreDisplay.textContent = shaifaliQuestionsAnswered;
        }

        function updateBirthdayRevealNavButtons() {
            if (shaifaliChosenAnswer) {
                if (currentQuestionIndex < allQuestions.length - 1) {
                    if (brNextQuestionButton) brNextQuestionButton.classList.remove('hidden');
                } else {
                    if (brRevealFamilyAnswersButton && brRevealFamilyAnswersButton.classList.contains('hidden')) {
                        if (brRestartButton) brRestartButton.classList.remove('hidden');
                        setTimeout(endBirthdayRevealMode, 2000); 
                    } else if (!brRevealFamilyAnswersButton || brRevealFamilyAnswersButton.classList.contains('hidden')) {
                        if (brRestartButton) brRestartButton.classList.remove('hidden');
                         setTimeout(endBirthdayRevealMode, 2000); 
                    }
                }
            } else {
                if (brNextQuestionButton) brNextQuestionButton.classList.add('hidden');
                if (brRestartButton) brRestartButton.classList.add('hidden');
            }
        }

        function endBirthdayRevealMode() {
            if (birthdayRevealScreen) birthdayRevealScreen.classList.add('hidden');
            if (brEndScreen) brEndScreen.classList.remove('hidden');

            document.getElementById('revealPuppy').classList.add('hidden'); // Hide puppy
            document.getElementById('endKitten').classList.remove('hidden'); // Show kitten
            document.getElementById('endBunny').classList.remove('hidden'); // Show bunny
            
            let winnerNames = [];
            let maxMatches = 0;

            for (const name in familyOverallMatchCounts) {
                const matches = familyOverallMatchCounts[name];
                if (matches > maxMatches) {
                    maxMatches = matches;
                    winnerNames = [name]; 
                } else if (matches === maxMatches && matches > 0) {
                    winnerNames.push(name); 
                }
            }

            if (brFinalScoreDisplay) {
                if (winnerNames.length > 0) {
                    brFinalScoreDisplay.textContent = winnerNames.join(' & ') + (winnerNames.length > 1 ? '!' : '!');
                } else {
                    brFinalScoreDisplay.textContent = "No matches! Better luck next time!";
                }
            }

            if (leaderboardList) {
                leaderboardList.innerHTML = '';
                const sortedScores = Object.entries(familyOverallMatchCounts).sort(([, a], [, b]) => b - a);
                sortedScores.forEach(([name, matches]) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${name}: ${matches} match(es)`;
                    if (matches === maxMatches && maxMatches > 0) {
                        listItem.classList.add('winner');
                    }
                    leaderboardList.appendChild(listItem);
                });
            }

            triggerCelebrationEffect('final'); 
        }

        // --- New Celebration Effects Logic ---
        function triggerCelebrationEffect(typeOrIndex) {
            removeAllParticles(); 

            let effectType;
            if (typeOrIndex === 'final') {
                effectType = 'rainbow-confetti'; 
            } else {
                const effectIndex = typeOrIndex % 4; 
                switch (effectIndex) {
                    case 0: effectType = 'rainbow-confetti'; break;
                    case 1: effectType = 'star-burst'; break;
                    case 2: effectType = 'floating-hearts'; break;
                    case 3: effectType = 'flying-unicorns'; break;
                    default: effectType = 'rainbow-confetti'; break;
                }
            }
            
            console.log("Triggering celebration effect for index/type:", typeOrIndex, "->", effectType);

            switch (effectType) {
                case 'rainbow-confetti':
                    createConfettiParticles(100, ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3']); 
                    break;
                case 'star-burst':
                    createStarParticles(50);
                    break;
                case 'floating-hearts':
                    createHeartParticles(30);
                    break;
                case 'flying-unicorns':
                    createUnicornParticles(10);
                    break;
            }
            setTimeout(removeAllParticles, 4000); 
        }

        function createConfettiParticles(count, colors) {
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -20}px`; 
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${3 + Math.random() * 2}s`;
                confetti.style.setProperty('--initial-x', `${(Math.random() - 0.5) * 200}px`);
                confetti.style.setProperty('--final-x', `${(Math.random() - 0.5) * 400}px`);
                document.body.appendChild(confetti);
            }
        }

        function createStarParticles(count) {
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.classList.add('star-particle');
                star.style.left = `${50 + (Math.random() - 0.5) * 30}vw`; 
                star.style.top = `${50 + (Math.random() - 0.5) * 30}vh`;
                star.style.animationDelay = `${Math.random() * 0.2}s`;
                star.style.animationDuration = `${1.5 + Math.random() * 0.8}s`;
                star.style.setProperty('--initial-x', `${(Math.random() - 0.5) * 200}px`);
                star.style.setProperty('--initial-y', `${(Math.random() - 0.5) * 200}px`);
                star.style.setProperty('--final-x', `${(Math.random() - 0.5) * 300}px`);
                star.style.setProperty('--final-y', `${(Math.random() - 0.5) * 300}px`);
                star.style.setProperty('--initial-rotate', `${Math.random() * 360}deg`);
                star.style.setProperty('--final-rotate', `${360 + Math.random() * 360}deg`);
                document.body.appendChild(star);
            }
        }

        function createHeartParticles(count) {
            for (let i = 0; i < count; i++) {
                const heart = document.createElement('div');
                heart.classList.add('heart-particle');
                heart.style.left = `${Math.random() * 100}vw`;
                heart.style.bottom = `${Math.random() * -100}px`; 
                heart.style.animationDelay = `${Math.random() * 0.8}s`;
                heart.style.animationDuration = `${4 + Math.random() * 2}s`;
                heart.style.setProperty('--initial-x', `${(Math.random() - 0.5) * 100}px`);
                heart.style.setProperty('--final-x', `${(Math.random() - 0.5) * 150}px`);
                document.body.appendChild(heart);
            }
        }

        function createUnicornParticles(count) {
            const unicornSVG = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C10.9 2 10 2.9 10 4V7H5V12H7V22H17V12H19V7H14V4C14 2.9 13.1 2 12 2Z" fill="#FFC0CB"/>
                <path d="M12 2C10.9 2 10 2.9 10 4V7H5V12H7V22H17V12H19V7H14V4C14 2.9 13.1 2 12 2Z" stroke="#E91E63" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 2L13 3L12 4L11 3L12 2Z" fill="#FFD700"/>
                <path d="M12 2L13 3L12 4L11 3L12 2Z" stroke="#DAA520" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 10L20 9L21 11L18 12L17 10Z" fill="#BA68C8"/>
                <path d="M17 10L20 9L21 11L18 12L17 10Z" stroke="#9C27B0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="10" cy="9" r="1.5" fill="#2C3E50"/>
                </svg>
            `; 

            for (let i = 0; i < count; i++) {
                const unicornWrapper = document.createElement('div');
                unicornWrapper.classList.add('unicorn-particle');
                unicornWrapper.innerHTML = unicornSVG;
                
                const startX = Math.random() < 0.5 ? -10 : 110; 
                const endX = startX < 0 ? Math.random() * 100 : (Math.random() * -100);
                const startY = Math.random() * 100;
                const endY = Math.random() * 100;

                unicornWrapper.style.left = `${startX}vw`;
                unicornWrapper.style.top = `${startY}vh`;
                unicornWrapper.style.animationDelay = `${Math.random() * 1}s`;
                unicornWrapper.style.animationDuration = `${5 + Math.random() * 2}s`;
                unicornWrapper.style.setProperty('--initial-x', `${startX}vw`);
                unicornWrapper.style.setProperty('--mid-x', `${(Math.random() * 50) + 25}vw`); 
                unicornWrapper.style.setProperty('--final-x', `${endX}vw`);
                unicornWrapper.style.setProperty('--mid-y', `${(Math.random() * 50) + 25}vh`);
                unicornWrapper.style.setProperty('--final-y', `${endY}vh`);
                unicornWrapper.style.setProperty('--mid-rotate', `${(Math.random() - 0.5) * 90}deg`);
                unicornWrapper.style.setProperty('--final-rotate', `${(Math.random() - 0.5) * 180 + 360}deg`);
                
                document.body.appendChild(unicornWrapper);
            }
        }

        function removeAllParticles() {
            document.querySelectorAll('.confetti, .star-particle, .heart-particle, .unicorn-particle').forEach(p => p.remove());
        }

        // --- Firebase Integration and Data Paths ---
        // Firestore security rules (example - you'll need to set these in your Firebase project):
        //
        // You'll need these rules in your Firebase Firestore "Rules" tab:
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //
        //     // Rules for family member responses
        //     match /artifacts/{appId}/public/data/family_responses/{documentId} {
        //       allow read: if request.auth != null; // Anyone authenticated can read family responses
        //       allow write: if request.auth != null; // Anyone authenticated can write family responses
        //     }
        //
        //     // Rules for Shaifali's official answers
        //     match /artifacts/{appId}/public/data/shaifali_answers/{questionId} {
        //       allow read: if request.auth != null; // Anyone authenticated can read Shaifali's answers
        //       // Allow write for authenticated users (Shaifali or you)
        //       allow write: if request.auth != null;
        //     }
        //   }
        // }

    </script>
</body>
</html>


